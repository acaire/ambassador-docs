import Alert from '@material-ui/lab/Alert';

# $productName$ System Architecture

$productName$ is built on [Envoy Gateway][] and enhances its [Kubernetes][]-native API Gateway capabilities
by providing advanced security and protection features. This guide outlines the architecture and components
of $productName$ at a high level.

## How Does $productName$ Work?

At its core, $productName$ extends the functionality of the open-source [Envoy Gateway][] application gateway by
adding several new components and resources that give users access to a wide array of authentication
options (OAuth2, OIDC, JWT, Single Sign-On, etc.) and easily configurable Web Application Firewalls.

<br/>

When you install $productName$, Envoy Gateway is also installed by default. Envoy Gateway watches
and reads [Gateway API Resources][] to configure routing incoming traffic to [Kubernetes Services][]. $productName$
runs separately from Envoy Gateway and watches some of its own custom resources to provide the features mentioned above.

Using the Gateway API Resources, Envoy Gateway creates, manages, and configures a fleet of [Envoy Proxy][] deployments.
Envoy Gateway and $productName$ work together to create the configuration for Envoy Proxy and also run additional services \
that Envoy Proxy communicates with to provide logic and functionality not available in Envoy Proxy.

## System Architecture Diagram

<div class="docs-diagram-wrapper">

![Edge Stack Architecture](/../../images/documentation/EdgeStack4Architecture.inline.svg)

</div>

When Envoy Proxy is configured by Envoy Gateway and $productName$, it works as the [Data Plane][] by
listening for and processing the incoming requests and then communicating with $productName$ for
the added [Web Application Firewall][] and [Authentication][] support.

## Components of $productName$

### Edge Stack

The main deployment of Edge Stack (just referred to as Edge Stack) is the component
that communicates with Envoy Gateway to generate the necessary Envoy Proxy config. Edge Stack receives Envoy Proxy config
generated by Envoy Gateway and modifies the config to add its own features and functionality. Edge Stack then
sends this modified Envoy config back to Envoy Gateway, which pushes it out to the running instance(s) of Envoy Proxy.

### WAF Service

The Edge Stack WAF Service also runs in its own deployment, similar to the Auth Service. Edge Stack modifies the Envoy config generated by
Envoy Gateway and adds a [Go Filter][], which runs on all requests going through Envoy Proxy and always runs before the [ext_authz Filter][]
that communicates with the Auth Service over [gRPC][]. This Go Filter calls out to the WAF Service during four key phases of request handling:

1. Incoming request headers
2. Incoming request body
3. Outgoing response headers
4. Outgoing response body

These four phases align with the four phases in which $productName$'s Web Application Firewalls process requests/responses. Unfortunately,
context is not preserved across the four phases, so any Firewall rules that rely on data defined or modified in a previous phase are not supported.

The WAF Service itself watches for [WebApplicationFirewall][] and [WebApplicationFirewallPolicy][] custom resources, and if configured, it can
provide Web Application Firewall processing on requests/responses. If there are no `WebApplicationFirewall`/`WebApplicationFirewallPolicy` resources
configured to run for the request/response being processed, then the WAF Service will send an early reply to the Go Filter so that it doesn't
waste any time transmitting request/response bodies that are not needed. The same thing happens if you have configured the `WebApplicationFirewall` to not run
any processing on request/response bodies.

Processing request and response bodies can add some additional security; however, it will increase request latency by a non-trivial amount, so it is recommended
not to use it when securing applications and services that are very sensitive to any increase in latency.

The following docs will help you get started with the features provided by the WAF Service:

- [Using Web Application Firewalls][] - Get started using `WebApplicationFirealls` quickly
- [Rules for Web Application Firewalls][] - Info about creating and configuring firewall rules
- [Web Application Firewalls in Production][] - Recommendations and info for creating and running `WebApplicationFirewalls` in a production environment

### Auth Service

The Edge Stack WAF Service exists as a separate deployment from Envoy Gateway and the main Edge Stack deployment.
Edge Stack modifies the Envoy config generated by Envoy Gateway and adds an [ext_authz Filter][] which runs on all requests going through
Envoy Proxy. The ext_authz Filter provides authentication features by calling out to the Auth Service on incoming requests using [gRPC][].
Responses from upstream services are not processed by the Auth Service or any of the functionality and features it provides.

<br/>

The Auth Service watches [Filter][] and [FilterPolicy][] custom resources to provide features for authenticating or rejecting incoming requests
and allowing users to configure custom filtering and processing on incoming requests.

The following docs will help you get started with the features provided by the Auth Service:

- [Single Sign-On with OAuth2 Filters][] - Use the OAuth2 `Filter` to set up single sign-on and protect your applications
- [Custom Logic with External Filters][] - Defer filtering logic to your own application/service for added control
- [Check JWTs with the JWT Filter][] - Make sure that incoming requests have a JWT, and then make sure it is valid

### Redis

[Redis][] is used by the components of $productName$ to share some state information and to track and report usage info and metrics back to Ambassador Labs.

The Auth Service and WAF Service read and write to Redis to keep track of the current and maximum number of requests per second they process. Edge Stack only reads
from Redis to observe the usage information generated by the other components and then sends reports back to Ambassador Labs every 12 hours.

## Envoy Gateway

Envoy Gateway watches the [Gateway API custom resources] and Envoy Gateway's custom resources which are consumed to create and manage infrastructure such as [Kubernetes Services][] and [Deployments][]
of Envoy Proxy, and also to generate the Envoy config used by Envoy Proxy. After Envoy Gateway generates the Envoy Config, it sends portions of the Envoy Config to Edge Stack via
[gRPC][] requests. Edge Stack then adds to the Envoy config and sends it back to Envoy Gateway. Finally, Envoy Gateway pushes the finalized Envoy config to the managed Envoy Proxy fleet.
Envoy Gateway also runs a global rate-limiting service. If Envoy Gateway's Rate Limiting is configured, it always runs after $productName$'s `Filters`/`FilterPolicies`.

For more details information about the system architecture of Envoy Gateway, you can refer to the [Envoy Gateway docs][]

The following guides will help you with configuring the Envoy Gateway and Envoy Proxy deployments:

- [Configuring the Envoy Proxy Deployment][] - Use the `EnvoyProxy` resource to configure the Envoy Proxy deployment and pods
- [Configuring the Envoy Gateway Deployment][] - Use the `EnvoyGateway` resource to configure the Envoy Gateway deployment and pods
- [The EnvoyProxy API Reference][] - The `EnvoyProxy` API reference gives a detailed overview of all the fields the resource supports
- [The EnvoyGateway API Reference][] - The `EnvoyGateway` API reference gives a detailed overview of all the fields the resource supports

## Request Flow

In $productName$, the following process occurs when a downstream client initiates a request.

1. First, Envoy Proxy executes the [Go Filter][] added by $productName$.
   - The Go filter causes Envoy to make a request to $productName$'s [waf service][] for processing.
   - If any `WebApplicationFirewall`/`WebApplicationFirewallPolicy` resources are configured, their firewall processing will run against the
   incoming request.
   - If any Web Application Firewalls block the request, then the process ends here, and Envoy sends the response configured by your `WebApplicationFirewall` to the client.

2. Next, Envoy Proxy executes the [ext_authz filter][] added by $productName$.
   - The ext_authz filter causes Envoy to make a request to $productName$'s [auth service][] for processing.
   - If any `Filter`/`FilterPolicy` resources are configured, they run according to the configuration of your `FilterPolicies`.
   - If any of your `Filters` block the request, then the process ends here, and Envoy sends the response configured by your `Filter` to the client

3. If you have rate-limiting configured in Envoy Gateway, then Envoy executes a [Ratelimit filter][].
   - Envoy makes a request to Envoy Gateway to determine if the request should be rate-limited or allowed.
   - If the request is rate-limited,  then the process ends here, and Envoy sends a response to the downstream client.

4. Envoy proxies the request to the upstream Service

5. The upstream service sends its response to Envoy

6. the [Go Filter][] is executed again, running any configured WAF processing on the response from the upstream Service
   - If the response is blocked at this point, then Envoy Proxy sends the response configured by your `WebApplicationFirewall` to the downstream client.

7. Envoy proxies the response to the downstream client

<div class="docs-diagram-wrapper">

![Edge Stack Request Flow](/../../images/documentation/EdgeStack4RequestFlow.inline.svg)

</div>

[waf service]: #waf-service
[auth service]: #auth-service
[Web Application Firewall]: ../../guides/web-application-firewalls/setup
[Authentication]: ../../guides/sso/oauth2-sso
[Configuring the Envoy Proxy Deployment]: ../../guides/eg/envoy-config
[Configuring the Envoy Gateway Deployment]: ../../guides/eg/envoy-gateway-config
[Filter]: ../../custom-resources/filter
[FilterPolicy]: ../../custom-resources/filterpolicy
[WebApplicationFirewall]: ../../custom-resources/webapplicationfirewall
[WebApplicationFirewallPolicy]: ../../custom-resources/webapplicationfirewallpolicy
[The EnvoyProxy API Reference]: https://gateway.envoyproxy.io/v0.5.0/api/config_types.html
[The EnvoyGateway API Reference]: https://gateway.envoyproxy.io/v0.5.0/api/config_types.html
[Single Sign-On with OAuth2 Filters]: ../../guides/sso/oauth2-sso
[Custom Logic with External Filters]: ../../guides/custom-filters/external
[Check JWTs with the JWT Filter]: ../../guides/auth/jwt
[Using Web Application Firewalls]: ../../guides/web-application-firewalls/setup
[Rules for Web Application Firewalls]: ../../guides/web-application-firewalls/rules
[Web Application Firewalls in Production]: ../../guides/web-application-firewalls/production
[ext_authz Filter]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter
[Envoy Gateway]: https://github.com/envoyproxy/gateway
[Kubernetes]: https://kubernetes.io/
[Gateway API Resources]: https://gateway-api.sigs.k8s.io/
[Kubernetes Services]: https://kubernetes.io/docs/concepts/services-networking/service/
[Envoy Proxy]: https://www.envoyproxy.io/
[Data Plane]: https://www.snaplogic.com/blog/data-plane-vs-control-plane-whats-the-difference
[gRPC]: https://grpc.io/about/
[Go Filter]: https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/golang_filter
[Envoy Gateway docs]: https://gateway.envoyproxy.io/v0.4.0/design/system-design.html
[Redis]: https://redis.io/
[Ratelimit filter]: https://www.envoyproxy.io/docs/envoy/latest/configuration/other_features/rate_limit
[Deployments]: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/
